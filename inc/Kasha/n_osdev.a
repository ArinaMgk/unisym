;Name	Date and Time and device timer.
;Used	NASM 2.07
;Author	The forever Arina
;Check	Haruno
;Code	GBK

;	Copyright 2023 ArinaMgk
;	
;	Licensed under the Apache License, Version 2.0 (the "License");
;	you may not use this file except in compliance with the License.
;	You may obtain a copy of the License at
;	
;	http://www.apache.org/licenses/LICENSE-2.0
;	
;	Unless required by applicable law or agreed to in writing, software
;	distributed under the License is distributed on an "AS IS" BASIS,
;	WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
;	See the License for the specific language governing permissions and
;	limitations under the License.
;

%imacro Addr20Enable 0
	IN AL,0x92
	OR AL,00000010B
	OUT 0X92,AL
%endmacro

%imacro GDTDptrStruct 3
	%ifnidni EAX,%1
	MOV EAX,%1
	%endif
	%ifnidni EBX,%2
	MOV EBX,%2
	%endif
	%ifnidni ECX,%3
	MOV ECX,%3
	%endif
	MOV EDX,EAX
	SHL EAX,16
	; EDX:EAX=[BASEADDR (32~0)]:[BASEADDR (15~0)16][ZERO 16]
	OR AX,BX
	AND EDX,0XFFFF0000
	ROL EDX,8
	; EDX:EAX=[BASE 23~16][ZERO][BASE 31~24]:[BASEADDR (15~0)16][SEGLIMIT 16]
	;IF YOU CAN'T SEE, REFER AGURICHAN' NOTE~
	BSWAP EDX; NA 31~24,23~16
	; EDX:EAX=[BASE 31~24][ZERO][BASE 23~16]:[BASEADDR (15~0)16][SEGLIMIT 16]
	XOR BX,BX; REMAIN HIGH 16BIT
	OR EDX,EBX; HIGH 4 BIT
	OR EDX,ECX; PROPERTY
%endmacro

%imacro GDTDptrAppend 0-2 0,0
 MOV DWORD[EBX],%2;
 ADD EBX,0X04;
 MOV DWORD[EBX],%1;
 ADD EBX,0X04;
%endmacro

%imacro GateStruct 3
	%ifnidni EAX,%1
		MOV EAX,%1
	%endif
	%ifnidni BX,%2
		MOV BX,%2
	%endif
	%ifnidni CX,%3
		MOV CX,%3
	%endif
	MOV EDX,EAX
	AND EDX,0xFFFF0000
	OR DX,CX
	AND EAX,0x0000FFFF
	SHL EBX,16
	OR EAX,EBX
%endmacro
